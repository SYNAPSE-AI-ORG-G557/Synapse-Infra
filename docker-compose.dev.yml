services:
  frontend:
    build:
      context: ../Synapse-Frontend
      dockerfile: Dockerfile.dev
    command: npm run dev
    volumes:
      - ../Synapse-Frontend:/app
      - /app/node_modules
    ports:
      - "4173:4173"
    environment:
      - CHOKIDAR_USEPOLLING=true
    networks:
      - default

  orchestrator:
    build:
      context: ../Tooling_Engine
      dockerfile: Dockerfile.optimized
    command: uvicorn main:app --host 0.0.0.0 --port 8010
    ports:
      - "8010:8010"
    volumes:
      - ../Tooling_Engine:/app
    env_file:
      - ../Tooling_Engine/.env
    depends_on:
      - web_search_server
      - reminder_server
      - file_access_server
      - shell_server
      - weather_server
      - browser_server
      - google_calendar_server
      - gmail_server
      - jarvis_automation_server
      - google_drive_server
      - google_sheets_server
      - mcp_gateway
      - redis
    networks:
      - default

  # Official MCP Gateway - MCP-compliant gateway using official SDK
  mcp_gateway:
    build:
      context: ../Synapse-Worker
      dockerfile: Dockerfile.mcp-gateway
    container_name: synapse-mcp-gateway
    ports:
      - "8020:8000"
    environment:
      - PYTHONPATH=/app
    networks:
      - default
    depends_on:
      - weather_server
      - browser_server
      - web_search_server
      - gmail_server
      - google_calendar_server
      - reminder_server
      - file_access_server
      - shell_server
      - jarvis_automation_server
      - google_drive_server
      - google_sheets_server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  backend:
    build:
      context: ../Synapse-Backend
      dockerfile: Dockerfile
    volumes:
      - ../Synapse-Backend:/code
    ports:
      - "8000:8000"
    env_file:
      - ./.env
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_started }
      qdrant: { condition: service_started }
    environment:
      # Database Configuration
      - POSTGRES_USER=${POSTGRES_USER:-synapse_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-synapse_password}
      - POSTGRES_SERVER=${POSTGRES_SERVER:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-synapse_db}
      # Database Connection Pooling
      - DB_POOL_SIZE=${DB_POOL_SIZE:-5}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW:-10}
      - DB_POOL_TIMEOUT=${DB_POOL_TIMEOUT:-30}
      - DB_POOL_RECYCLE=${DB_POOL_RECYCLE:-1800}
      - DB_POOL_PRE_PING=${DB_POOL_PRE_PING:-true}
      # Redis Configuration
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      # Qdrant Configuration
      - QDRANT_HOST=${QDRANT_HOST:-qdrant}
      - QDRANT_PORT=${QDRANT_PORT:-6333}
      - QDRANT_GRPC_PORT=${QDRANT_GRPC_PORT:-6334}
      # JWT Configuration
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-super-secret-jwt-key-change-this-in-production}
      - JWT_REFRESH_SECRET_KEY=${JWT_REFRESH_SECRET_KEY:-your-super-secret-refresh-key-change-this-in-production}
      - ALGORITHM=${ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      - REFRESH_TOKEN_EXPIRE_DAYS=${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      # Google OAuth2 Configuration
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      # Session Management
      - SESSION_SECRET_KEY=${SESSION_SECRET_KEY:-your-session-secret-key-change-this-in-production}
      # ML Configuration
      - ML_DEVICE=${ML_DEVICE:-cpu}
      - USE_API_LLM=${USE_API_LLM:-false}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-flash}
      # Ollama Configuration
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - OLLAMA_MODEL_PREFERENCE=${OLLAMA_MODEL_PREFERENCE:-phi3:mini}
      # Other Configuration
      - TRANSFORMERS_CACHE=/hf_cache
      - HF_HOME=/hf_cache
      - LOG_MODE=console
    networks:
      - default

  worker-cpu:
    build:
      context: ../Synapse-Worker
      dockerfile: Dockerfile
      target: worker-cpu
    container_name: synapse-worker-cpu
    command: celery -A src.worker worker -l info -Q cpu_light,cpu_heavy -c 1
    volumes:
      - ../Synapse-Worker:/app
      - ./hf_cache:/hf_cache
    env_file:
      - ./.env
    user: "1000:1000"
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_started }
      qdrant: { condition: service_started }
    environment:
      # Database Configuration
      - POSTGRES_USER=${POSTGRES_USER:-synapse_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-synapse_password}
      - POSTGRES_SERVER=${POSTGRES_SERVER:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-synapse_db}
      # Database Connection Pooling (Smaller for workers)
      - DB_POOL_SIZE=${DB_POOL_SIZE_WORKER:-3}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW_WORKER:-5}
      - DB_POOL_TIMEOUT=${DB_POOL_TIMEOUT:-30}
      - DB_POOL_RECYCLE=${DB_POOL_RECYCLE:-1800}
      - DB_POOL_PRE_PING=${DB_POOL_PRE_PING:-true}
      # Redis Configuration
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      # Qdrant Configuration
      - QDRANT_HOST=${QDRANT_HOST:-qdrant}
      - QDRANT_PORT=${QDRANT_PORT:-6333}
      - QDRANT_GRPC_PORT=${QDRANT_GRPC_PORT:-6334}
      # JWT Configuration
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-super-secret-jwt-key-change-this-in-production}
      - JWT_REFRESH_SECRET_KEY=${JWT_REFRESH_SECRET_KEY:-your-super-secret-refresh-key-change-this-in-production}
      - ALGORITHM=${ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      - REFRESH_TOKEN_EXPIRE_DAYS=${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      # Google OAuth2 Configuration
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      # Session Management
      - SESSION_SECRET_KEY=${SESSION_SECRET_KEY:-your-session-secret-key-change-this-in-production}
      # Worker Configuration
      - TRANSFORMERS_CACHE=/hf_cache
      - HF_HOME=/hf_cache
      - PYTHONPATH=/code
      - GIT_PYTHON_REFRESH=quiet
      - NLTK_DATA=/code/nltk_data
      - LOG_MODE=console
      - ML_DEVICE=cpu
      - WORKER_TYPE=cpu
      # Ollama Configuration
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - OLLAMA_MODEL_PREFERENCE=${OLLAMA_MODEL_PREFERENCE:-phi3:mini}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default

  worker-gpu:
    build:
      context: ../Synapse-Worker
      dockerfile: Dockerfile
      target: worker-gpu
    command: ["sh", "-c", "celery -A src.worker worker -Q gpu --pool=solo -n gpu-worker@%h"]
    volumes:
      - ../Synapse-Worker:/app
      - ./hf_cache:/hf_cache
    env_file:
      - ./.env
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    user: "1000:1000"
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_started }
      qdrant: { condition: service_started }
    environment:
      # Database Configuration
      - POSTGRES_USER=${POSTGRES_USER:-synapse_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-synapse_password}
      - POSTGRES_SERVER=${POSTGRES_SERVER:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-synapse_db}
      # Database Connection Pooling (Smaller for workers)
      - DB_POOL_SIZE=${DB_POOL_SIZE_WORKER:-3}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW_WORKER:-5}
      - DB_POOL_TIMEOUT=${DB_POOL_TIMEOUT:-30}
      - DB_POOL_RECYCLE=${DB_POOL_RECYCLE:-1800}
      - DB_POOL_PRE_PING=${DB_POOL_PRE_PING:-true}
      # Worker Configuration (override .env for GPU-specific settings)
      - ML_DEVICE=cuda
      - TRANSFORMERS_CACHE=/hf_cache
      - HF_HOME=/hf_cache
      - PYTHONPATH=/code
      - LOG_MODE=console
      - WORKER_TYPE=gpu
      # Ollama Configuration
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - OLLAMA_MODEL_PREFERENCE=${OLLAMA_MODEL_PREFERENCE:-phi3:mini}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - default

  beat:
    build:
      context: ../Synapse-Worker
      dockerfile: Dockerfile
      target: worker-cpu
    container_name: synapse-beat
    command: celery -A src.worker beat --loglevel=INFO
    volumes:
      - ../Synapse-Worker:/app
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_started }
    environment:
      # Database Configuration
      - POSTGRES_USER=${POSTGRES_USER:-synapse_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-synapse_password}
      - POSTGRES_SERVER=${POSTGRES_SERVER:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-synapse_db}
      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      # Qdrant Configuration
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_GRPC_PORT=6334
      # JWT Configuration
      - JWT_SECRET_KEY=your-super-secret-jwt-key-change-this-in-production
      - JWT_REFRESH_SECRET_KEY=your-super-secret-refresh-key-change-this-in-production
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
      - REFRESH_TOKEN_EXPIRE_DAYS=7
      # Google OAuth2 Configuration
      - GOOGLE_CLIENT_ID=your-google-client-id
      - GOOGLE_CLIENT_SECRET=your-google-client-secret
      # Session Management
      - SESSION_SECRET_KEY=your-session-secret-key-change-this-in-production
      # Beat Configuration
      - LOGLEVEL=INFO
      - BEAT_DBURI=postgresql://${POSTGRES_USER:-synapse_user}:${POSTGRES_PASSWORD:-synapse_password}@postgres:5432/${POSTGRES_DB:-synapse_db}
    networks:
      - default

  flower:
    build:
      context: ../Synapse-Worker
      dockerfile: Dockerfile
      target: worker-cpu
    container_name: synapse-flower
    command: celery -A src.worker flower --address=0.0.0.0 --port=5555
    ports:
      - "5556:5555"
    volumes:
      - ../Synapse-Worker:/app
    depends_on:
      - redis
    environment:
      - PYTHONPATH=/app
      # Database Configuration
      - POSTGRES_USER=synapse_user
      - POSTGRES_PASSWORD=synapse_password
      - POSTGRES_SERVER=postgres
      - POSTGRES_DB=synapse_db
      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      # Qdrant Configuration
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_GRPC_PORT=6334
      # JWT Configuration
      - JWT_SECRET_KEY=your-super-secret-jwt-key-change-this-in-production
      - JWT_REFRESH_SECRET_KEY=your-super-secret-refresh-key-change-this-in-production
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
      - REFRESH_TOKEN_EXPIRE_DAYS=7
      # Google OAuth2 Configuration
      - GOOGLE_CLIENT_ID=your-google-client-id
      - GOOGLE_CLIENT_SECRET=your-google-client-secret
      # Session Management
      - SESSION_SECRET_KEY=your-session-secret-key-change-this-in-production
    networks:
      - default

  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]
    networks:
      - default

  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-synapse_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-synapse_password}
      POSTGRES_DB: ${POSTGRES_DB:-synapse_db}
      # Connection limits and optimization
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
    ports: ["5433:5432"]
    volumes:
      - pgdata_dev:/var/lib/postgresql/data
      - ./configs/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./configs/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c max_worker_processes=8
      -c max_parallel_workers_per_gather=4
      -c max_parallel_workers=8
      -c max_parallel_maintenance_workers=4
      -c log_statement=none
      -c log_min_messages=error
      -c log_min_duration_statement=-1
      -c log_checkpoints=off
      -c log_connections=off
      -c log_disconnections=off
      -c log_hostname=off
      -c log_line_prefix=''
      -c log_lock_waits=off
      -c log_temp_files=-1
      -c log_autovacuum_min_duration=-1
      -c log_replication_commands=off
      -c track_activities=on
      -c track_counts=on
      -c track_io_timing=on
      -c track_functions=all
      -c shared_preload_libraries=vector
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-synapse_user} -d ${POSTGRES_DB:-synapse_db} -q"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    networks:
      - default

  qdrant:
    image: qdrant/qdrant:latest
    container_name: synapse-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - default

  web_search_server:
    build:
      context: ../Tooling_Engine
      dockerfile: Dockerfile.optimized
    command: uvicorn mcp_servers.web_search_server:app --host 0.0.0.0 --port 8001
    ports:
      - "8001:8001"
    volumes:
      - ../Tooling_Engine/mcp_servers:/app/mcp_servers
    networks:
      - default

  reminder_server:
    build:
      context: ../Tooling_Engine
      dockerfile: Dockerfile.optimized
    command: uvicorn mcp_servers.reminder_server:app --host 0.0.0.0 --port 8003
    ports:
      - "8003:8003"
    volumes:
      - ../Tooling_Engine/mcp_servers:/app/mcp_servers
    networks:
      - default

  file_access_server:
    build:
      context: ../Tooling_Engine
      dockerfile: Dockerfile.optimized
    command: uvicorn mcp_servers.file_access_server:app --host 0.0.0.0 --port 8002
    ports:
      - "8002:8002"
    volumes:
      - ../Tooling_Engine/mcp_servers:/app/mcp_servers
      - ../Tooling_Engine/sandboxed_files:/app/safe_files
    networks:
      - default

  shell_server:
    build:
      context: ../Tooling_Engine
      dockerfile: Dockerfile.optimized
    command: uvicorn mcp_servers.shell_server:app --host 0.0.0.0 --port 8004
    ports:
      - "8004:8004"
    volumes:
      - ../Tooling_Engine/mcp_servers:/app/mcp_servers
    networks:
      - default

  weather_server:
    build:
      context: ../Tooling_Engine
      dockerfile: Dockerfile.optimized
    command: uvicorn mcp_servers.weather_server:app --host 0.0.0.0 --port 8006
    env_file:
      - .env
    ports:
      - "8006:8006"
    volumes:
      - ../Tooling_Engine/mcp_servers:/app/mcp_servers
    networks:
      - default
    dns:
      - 8.8.8.8
      - 8.8.4.4

  google_calendar_server:
    build:
      context: ../Tooling_Engine
      dockerfile: Dockerfile.optimized
    command: uvicorn mcp_servers.google_calendar_server:app --host 0.0.0.0 --port 8007
    ports:
      - "8007:8007"
    volumes:
      - ../Tooling_Engine/mcp_servers:/app/mcp_servers
    networks:
      - default
    restart: unless-stopped

  gmail_server:
    build:
      context: ../Tooling_Engine
      dockerfile: Dockerfile.optimized
    command: uvicorn mcp_servers.gmail_server:app --host 0.0.0.0 --port 8008
    ports:
      - "8008:8008"
    volumes:
      - ../Tooling_Engine/mcp_servers:/app/mcp_servers
    networks:
      - default
    restart: unless-stopped

  browser_server:
    build:
      context: ../Tooling_Engine
      dockerfile: Dockerfile.prebuilt
    command: uvicorn mcp_servers.browser_server:app --host 0.0.0.0 --port 8005
    ports:
      - "8005:8005"
    volumes:
      - ../Tooling_Engine/mcp_servers:/app/mcp_servers
    networks:
      - default
    restart: unless-stopped

  jarvis_automation_server:
    build:
      context: ../Synapse-Worker
      dockerfile: Dockerfile.automation
    ports:
      - "8012:8012"
    volumes:
      - ../Synapse-Worker/src:/app/src
    networks:
      - default
    restart: unless-stopped

  google_drive_server:
    build:
      context: ../Tooling_Engine
      dockerfile: Dockerfile.optimized
    command: uvicorn mcp_servers.google_drive_server:app --host 0.0.0.0 --port 8013
    ports:
      - "8013:8013"
    volumes:
      - ../Tooling_Engine/mcp_servers:/app/mcp_servers
    networks:
      - default
    restart: unless-stopped

  google_sheets_server:
    build:
      context: ../Tooling_Engine
      dockerfile: Dockerfile.optimized
    command: uvicorn mcp_servers.google_sheets_server:app --host 0.0.0.0 --port 8011
    ports:
      - "8011:8011"
    volumes:
      - ../Tooling_Engine/mcp_servers:/app/mcp_servers
    networks:
      - default
    restart: unless-stopped


volumes:
  pgdata_dev: {}
  qdrant_data: {}
  hf_cache: {}

networks:
  default:
    name: synapse_dev_network